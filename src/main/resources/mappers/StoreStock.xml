<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goldensnitch.qudditch.mapper.StoreStockMapper">
    <select id="cntProductByUserStoreId" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM store_stock WHERE user_store_id = #{userStoreId}
    </select>
    <select id="selectAllProductByUserStoreId" parameterType="int" resultType="StoreStockRes">
        SELECT s.*, c.name as categoryName, p.name as productName, p.brand as brand, p.image as productImage, p.price as productPrice
        FROM store_stock s , product p, category c
        WHERE user_store_id = #{userStoreId} and s.product_id = p.id and p.category_id = c.id
    </select>
    <select id="selectProductByUserStoreIdAndProductId" parameterType="StoreStock" resultType="StoreStock">
        SELECT * FROM store_stock WHERE user_store_id = #{userStoreId} and product_id = #{productId}
    </select>
    <update id="updateStock" parameterType="StoreStock">
        UPDATE store_stock
        SET qty = #{qty}, position_id = #{positionId}
        WHERE user_store_id = #{userStoreId} and product_id = #{productId}
    </update>
    <select id="selectProductByUserStoreIdAndCategoryId">
        SELECT s.*, c.name as categoryName, p.name as productName, p.brand as brand, p.image as productImage, p.price as productPrice
        FROM store_stock s , product p, category c
        WHERE user_store_id = #{userStoreId} and s.product_id = p.id and p.category_id = c.id and p.category_id = #{categoryId}
    </select>
    <select id="cntProductByUserStoreIdAndCategoryId">
        SELECT COUNT(*)
        FROM store_stock s , product p, category c
        WHERE user_store_id = #{userStoreId} and s.product_id = p.id and p.category_id = c.id and p.category_id = #{categoryId}
    </select>

    <select id="selectStoreByProductId"  resultType="StoreLocQty">
        select s.id, s.name as name, s.address as address, s.wgs84_x, s.wgs84_y, ss.qty
        from store s, store_stock ss, user_store us
        where ss.product_id = #{productId} and s.id = us.store_id and us.id = ss.user_store_id
        ORDER BY (6371
            *ACOS(COS(RADIANS(#{currentWgs84X}))
                      *COS(RADIANS(s.wgs84_x))
                      *COS(radians(s.wgs84_y)-RADIANS(#{currentWgs84Y}))
                +SIN(RADIANS(${currentWgs84X}))*SIN(RADIANS(wgs84_x))))
        LIMIT 10;
    </select>

    <insert id="insertDisposeLog">
        INSERT INTO store_stock_disuse (user_store_id, product_id, qty)
        VALUES (#{userStoreId}, #{productId}, #{qty})
    </insert>
    <select id="getDisposeLogCount" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM store_stock_disuse WHERE user_store_id = #{userStoreId}
    </select>
    <select id="getDisposeLog" parameterType="int" resultType="DisposeLog">
        SELECT * FROM store_stock_disuse WHERE user_store_id = #{userStoreId}
    </select>
    <select id="getOrderListByUserStoreId">
        SELECT si.id as storeInputId,
               si.input_at,
               CONCAT(
                       CASE
                           WHEN COUNT(p.id) > 1 THEN CONCAT(
                                   SUBSTRING_INDEX(GROUP_CONCAT(p.name ORDER BY p.id ASC SEPARATOR ', '), ',', 1),
                                   ' 외 ',
                                   COUNT(p.id) - 1,
                                   '개'
                                                     )
                           ELSE GROUP_CONCAT(p.name ORDER BY p.id ASC SEPARATOR ', ')
                           END
               ) AS items
        FROM store s,product p
                         INNER JOIN
        store_input_product sip ON sip.product_id = p.id
                         INNER JOIN
        store_input si ON si.id = sip.store_input_id
        where s.id = si.user_store_id and user_store_id = ${userStoreId}
        GROUP BY si.id, si.input_at;
    </select>
    <select id="getOrderDetailByStoreInputId">
        select p.id as productId, p.brand, p.name, p.price, sip.qty, sip.state, sip.exp_date as expDate
        from product p, store_input si, store_input_product sip
        where p.id = sip.product_id and si.id = sip.store_input_id and si.id = ${storeInputId}
    </select>
    <insert id="insertStoreStock" >
        INSERT INTO store_stock (user_store_id, product_id, qty, position_id, expired_at)
        VALUES (#{userStoreId}, #{productId}, #{qty}, #{positionId}, #{expiredAt})
    </insert>
    <update id="updateConfirmInput">
        update store_input_product
        set state = '검수완료'
        where store_input_id = ${storeInputId} and product_id = ${productId}
    </update>
    <insert id="insertInputLog">
        insert into store_stock_report (user_store_id, product_id, ymd, in_qty)
        values (#{userStoreId}, #{productId}, #{ymd}, #{inQty})
    </insert>
    <select id="getInputDate">
        select input_at from store_input where id = ${storeInputId}
    </select>

    <!-- 재고 업데이트(결제된 품목 수량만큼 재고를 차감) -->
    <update id="updateStockQty">
        UPDATE store_stock
        SET qty = #{newQty}
        WHERE user_store_id = #{userStoreId} AND product_id = #{productId}
    </update>

    <!-- 판매 수량 기록 로그 -->
    <insert id="insertStoreStockReport">
        INSERT INTO store_stock_report (user_store_id, product_id, ymd, out_qty)
        VALUES (#{userStoreId}, #{productId}, #{ymd}, #{outQty})
    </insert>

    <!-- userStoreId와 productId로 가게의 상품재고 수 확인 -->
    <select id="selectProductQty" resultType="Integer">
        SELECT ss.qty
        FROM store_stock ss
                 JOIN product p ON ss.product_id = p.id
                 JOIN user_store us ON ss.user_store_id = us.id
        WHERE p.id = #{productId} AND us.id = #{userStoreId}
    </select>
</mapper>