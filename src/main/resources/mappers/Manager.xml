<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goldensnitch.qudditch.mapper.ManageMapper">
    <select id="getOrderList" resultType="OrderRes">
        SELECT so.id,
               so.ordered_at,
               s.name,
               CONCAT(
                       CASE
                           WHEN COUNT(p.id) > 1 THEN CONCAT(
                                   SUBSTRING_INDEX(GROUP_CONCAT(p.name ORDER BY p.id ASC SEPARATOR ', '), ',', 1),
                                   ' 외 ',
                                   COUNT(p.id) - 1,
                                   '개'
                                                     )
                           ELSE GROUP_CONCAT(p.name ORDER BY p.id ASC SEPARATOR ', ')
                           END
               ) AS items, so.state
        FROM store s,product p
                         INNER JOIN
        store_order_product sop ON sop.product_id = p.id
                         INNER JOIN
        store_order so ON so.id = sop.order_store_id
        where s.id = so.user_store_id
        GROUP BY so.id, so.ordered_at;
    </select>
    <select id="getOrderDetail" resultType="OrderDetailRes">
        select p.id as productId, p.brand, p.name, p.price, sop.qty, p.expiration_date as expirationDate
        from store_order_product sop, product p
        where order_store_id = ${orderStoreId} and sop.product_id = p.id
    </select>
    <update id="updateOrderState">
        update store_order
        set state = '입고'
        where id = ${orderStoreId}
    </update>
    <insert id="insertStoreInput">
        insert into store_input (store_order_id, user_store_id)
        values (${orderStoreId} ,${userStoreId})
        <selectKey resultType="int" keyProperty="no" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>
    <insert id="insertStoreInputProduct">
        insert into store_input_product(store_input_id, product_id, exp_date, qty)
        values (${storeInputId}, ${productId}, '${expirationDate}', ${qty})
    </insert>
    <select id="getUserStoreIdByOrderId">
        select user_store_id
        from store_order
        where id = ${orderStoreId}
    </select>

</mapper>